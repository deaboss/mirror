<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Mirror</title>
  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --text:rgba(255,255,255,0.92);
      --sub:rgba(255,255,255,0.70);
      --sub2:rgba(255,255,255,0.55);
    }
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Helvetica Neue",Arial,sans-serif;
      overflow:hidden;
    }

    /* Cursor hide ONLY */
    body.cursor-hidden, body.cursor-hidden * { cursor: none !important; }

    /* Rotate 90° counter-clockwise */
    .rot{
      position:fixed;
      top:0; left:0;
      width:100vh;
      height:100vw;
      transform-origin: top left;
      transform: rotate(-90deg) translateX(-100%);
      background:var(--bg);
      overflow:hidden;
    }

    /* Layout: tall usage, limited width */
    .wrap{
      height:100%;
      box-sizing:border-box;
      padding:42px 46px;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
    }
    .col{
      width:min(700px, 64vh);
      max-width:700px;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:18px;
    }

    .clock{
      font-size:clamp(52px, 6.2vh, 82px);
      font-weight:600;
      line-height:1.02;
      letter-spacing:-0.02em;
    }
    .date{
      margin-top:8px;
      font-size:clamp(16px, 2.0vh, 22px);
      font-weight:500;
      color:var(--sub);
    }

    /* Weather */
    .wxWidget{
      width:100%;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
    }
    .wxLeft{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
      width:100%;
    }
    .wxLoc{
      font-size:13px;
      letter-spacing:0.10em;
      text-transform:uppercase;
      color:var(--sub);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }

    /* Temp + (icon/hi-lo) on one line */
    .wxTempRow{
      display:flex;
      align-items:baseline;
      gap:18px;
      flex-wrap:nowrap;
      width:100%;
    }
    .wxTemp{
      font-size:clamp(52px, 6.6vh, 88px);
      font-weight:650;
      line-height:1.0;
      letter-spacing:-0.03em;
      color:var(--text);
      white-space:nowrap;
      flex:0 0 auto;
    }

    .wxRight{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:10px;
      flex:0 0 auto;
      min-width:0;
    }
    .wxIcon{
      width:clamp(44px, 5.0vh, 64px);
      height:clamp(44px, 5.0vh, 64px);
      opacity:0.95;
    }
    .wxHiLo{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:5px;
      font-size:clamp(14px, 1.8vh, 18px);
      color:var(--sub);
      white-space:nowrap;
    }
    .wxHiLo strong{ color:var(--text); font-weight:600; }

    .wxDesc{
      font-size:clamp(16px, 2.0vh, 22px);
      color:var(--sub);
      line-height:1.2;
      max-width:44ch;
    }
    .wxUpdated{
      font-size:clamp(12px, 1.5vh, 16px);
      color:var(--sub2);
    }

    .spacer{ height:200px; width:100%; }

    /* Graphs */
    .graph{ width:100%; }
    .graphHeader{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
      margin-bottom:8px;
    }
    .graphLabel{
      font-size:12px;
      letter-spacing:0.10em;
      text-transform:uppercase;
      color:var(--sub);
      white-space:nowrap;
    }
    .graphMeta{
      font-size:12px;
      color:var(--sub2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:55%;
      text-align:right;
    }
    svg{
      width:100%;
      height:clamp(86px, 10.5vh, 122px);
      display:block;
    }

    /* Satellite: square */
    .sat{ width:100%; }
    .sat img{
      width:100%;
      aspect-ratio:1 / 1;
      height:auto;
      object-fit:cover;
      display:block;
      border-radius:14px;
      opacity:0.92;
      filter:contrast(1.05) saturate(1.05);
      background:#111;
      max-height:360px; /* keeps it from getting huge */
    }

    @media (max-height: 760px){
      .wrap{ padding:34px 38px; }
      .col{ gap:14px; }
      .spacer{ height:18px; }
      svg{ height:78px; }
      .sat img{ max-height:260px; }
    }
    @media (max-height: 680px){
      .sat{ display:none; }
    }
  </style>
</head>
<body>
  <div class="rot">
    <div class="wrap">
      <div class="col">
        <div>
          <div id="clock" class="clock">--:--</div>
          <div id="date" class="date">---</div>
        </div>

        <!-- Weather widget -->
        <div class="wxWidget">
          <div class="wxLeft">
            <div class="wxLoc">San Luis Obispo, CA</div>

            <div class="wxTempRow">
              <div id="wxTemp" class="wxTemp">--°</div>

              <div class="wxRight">
                <div id="wxIcon" class="wxIcon" aria-label="Weather icon"></div>
                <div class="wxHiLo">
                  <div>H: <strong id="wxHigh">--°</strong></div>
                  <div>L: <strong id="wxLow">--°</strong></div>
                </div>
              </div>
            </div>

            <div id="wxDesc" class="wxDesc">Loading weather…</div>
            <div id="wxUpdated" class="wxUpdated"></div>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="graph">
          <div class="graphHeader">
            <div class="graphLabel">Temperature (°F)</div>
            <div id="tempMeta" class="graphMeta"></div>
          </div>
          <svg id="tempSvg" viewBox="0 0 1000 170" preserveAspectRatio="none"></svg>
        </div>

        <div class="graph">
          <div class="graphHeader">
            <div class="graphLabel">Surface wind (mph)</div>
            <div id="windMeta" class="graphMeta"></div>
          </div>
          <svg id="windSvg" viewBox="0 0 1000 170" preserveAspectRatio="none"></svg>
        </div>

        <div class="graph" id="rainWrap" style="display:none">
          <div class="graphHeader">
            <div class="graphLabel">Rain chance (%)</div>
            <div id="rainMeta" class="graphMeta"></div>
          </div>
          <svg id="rainSvg" viewBox="0 0 1000 170" preserveAspectRatio="none"></svg>
        </div>

        <div class="sat">
          <img id="satImg"
               alt="GOES-18 Satellite"
               src="https://cdn.star.nesdis.noaa.gov/GOES18/ABI/SECTOR/psw/GEOCOLOR/20260280201_GOES18-ABI-psw-GEOCOLOR-2400x2400.jpg" />
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Settings =====
    const REFRESH_MINUTES = 5;
    const CURSOR_HIDE_MS = 1500;

    const LAT = 35.2858;
    const LON = -120.6627;
    const HOURS_TO_PLOT = 24;

    const satBaseUrl =
      "https://cdn.star.nesdis.noaa.gov/GOES18/ABI/SECTOR/psw/GEOCOLOR/20260280201_GOES18-ABI-psw-GEOCOLOR-2400x2400.jpg";

    // ===== Cursor hide (ONLY cursor) =====
    let cursorTimer = null;
    function bumpCursorTimer(){
      document.body.classList.remove("cursor-hidden");
      clearTimeout(cursorTimer);
      cursorTimer = setTimeout(() => document.body.classList.add("cursor-hidden"), CURSOR_HIDE_MS);
    }
    window.addEventListener("load", bumpCursorTimer);
    ["mousemove","mousedown","touchstart","keydown"].forEach(evt => {
      window.addEventListener(evt, bumpCursorTimer, { passive: true });
    });

    // ===== Time/Date =====
    function updateClock(){
      const now = new Date();
      document.getElementById("clock").textContent =
        now.toLocaleTimeString([], { hour:"numeric", minute:"2-digit", hour12:true });
      document.getElementById("date").textContent =
        now.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });
    }

    // ===== Satellite =====
    function bustSatelliteCache(){
      const img = document.getElementById("satImg");
      if (img) img.src = `${satBaseUrl}?t=${Date.now()}`;
    }

    // ===== Helpers =====
    function parseWindMph(windSpeedStr){
      if(!windSpeedStr) return null;
      const nums = windSpeedStr.match(/\d+/g);
      if(!nums || nums.length === 0) return null;
      const a = Number(nums[0]);
      if(nums.length >= 2){
        const b = Number(nums[1]);
        if(Number.isFinite(a) && Number.isFinite(b)) return (a + b) / 2;
      }
      return Number.isFinite(a) ? a : null;
    }

    function hourLabel(iso){
      const d = new Date(iso);
      const h = d.getHours();
      const hr = ((h + 11) % 12) + 1;
      const ap = h < 12 ? "a" : "p";
      return `${hr}${ap}`;
    }

    function svgEl(name){
      return document.createElementNS("http://www.w3.org/2000/svg", name);
    }

    // ===== Minimal weather icons =====
    function iconSvg(kind){
      const common = `fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"`;
      if(kind === "sun"){
        return `<svg viewBox="0 0 24 24" class="wxIcon" aria-hidden="true">
          <circle cx="12" cy="12" r="4.2" ${common}></circle>
          <path d="M12 2.5v2.2M12 19.3v2.2M2.5 12h2.2M19.3 12h2.2M4.7 4.7l1.6 1.6M17.7 17.7l1.6 1.6M19.3 4.7l-1.6 1.6M6.3 17.7l-1.6 1.6" ${common}></path>
        </svg>`;
      }
      if(kind === "cloud"){
        return `<svg viewBox="0 0 24 24" class="wxIcon" aria-hidden="true">
          <path d="M7.5 18.5h9.0a4.0 4.0 0 0 0 0-8.0 5.5 5.5 0 0 0-10.7 1.7A3.5 3.5 0 0 0 7.5 18.5Z" ${common}></path>
        </svg>`;
      }
      if(kind === "partly"){
        return `<svg viewBox="0 0 24 24" class="wxIcon" aria-hidden="true">
          <path d="M9.5 7.5a4.0 4.0 0 0 1 5.6" ${common}></path>
          <path d="M8.2 4.6l.9 1.7M6.0 7.5H4.1M8.2 10.4l-.9 1.7" ${common}></path>
          <path d="M10.0 18.5h7.5a3.5 3.5 0 0 0 0-7.0 4.8 4.8 0 0 0-9.1 1.3" ${common}></path>
        </svg>`;
      }
      if(kind === "rain"){
        return `<svg viewBox="0 0 24 24" class="wxIcon" aria-hidden="true">
          <path d="M7.2 15.0h9.3a3.6 3.6 0 0 0 0-7.2 5.1 5.1 0 0 0-10.0 1.5" ${common}></path>
          <path d="M9 17.2l-1 2.0M13 17.2l-1 2.0M17 17.2l-1 2.0" ${common}></path>
        </svg>`;
      }
      if(kind === "fog"){
        return `<svg viewBox="0 0 24 24" class="wxIcon" aria-hidden="true">
          <path d="M7.2 12.5h9.3a3.6 3.6 0 0 0 0-7.2 5.1 5.1 0 0 0-10.0 1.5" ${common}></path>
          <path d="M4 16h16M6 19h12" ${common}></path>
        </svg>`;
      }
      return iconSvg("cloud");
    }

    function pickIcon(shortForecast){
      const s = (shortForecast || "").toLowerCase();
      if (s.includes("thunder")) return "rain";
      if (s.includes("rain") || s.includes("showers") || s.includes("drizzle")) return "rain";
      if (s.includes("fog") || s.includes("haze") || s.includes("smoke")) return "fog";
      if (s.includes("overcast")) return "cloud";
      if (s.includes("cloud")) return "partly";
      if (s.includes("sun") || s.includes("clear")) return "sun";
      return "cloud";
    }

    // ===== Graphs with axes =====
    function drawLineGraphWithAxes(svg, data, xLabels, ySuffix, stroke){
      const W=1000,H=170;
      const padL=64, padR=18, padT=14, padB=50;
      const innerW=W-padL-padR, innerH=H-padT-padB;

      svg.innerHTML = "";

      const clean = data.filter(v => Number.isFinite(v));
      if(clean.length < 2){
        const t = svgEl("text");
        t.setAttribute("x", W/2);
        t.setAttribute("y", H/2);
        t.setAttribute("fill", "#fff");
        t.setAttribute("opacity", "0.8");
        t.setAttribute("font-size", "18");
        t.setAttribute("text-anchor", "middle");
        t.textContent = "No data";
        svg.appendChild(t);
        return;
      }

      let min = Math.min(...clean);
      let max = Math.max(...clean);
      if(min === max){ min -= 1; max += 1; }

      const yTicks = [Math.round(min), Math.round((min + max)/2), Math.round(max)];
      yTicks.forEach(tv => {
        const y = padT + (1 - (tv - min)/(max - min)) * innerH;

        const gl = svgEl("line");
        gl.setAttribute("x1", padL);
        gl.setAttribute("x2", padL + innerW);
        gl.setAttribute("y1", y);
        gl.setAttribute("y2", y);
        gl.setAttribute("stroke", "rgba(255,255,255,0.10)");
        gl.setAttribute("stroke-width", "2");
        svg.appendChild(gl);

        const tx = svgEl("text");
        tx.setAttribute("x", padL - 10);
        tx.setAttribute("y", y + 6);
        tx.setAttribute("fill", "#fff");
        tx.setAttribute("opacity", "0.72");
        tx.setAttribute("font-size", "18");
        tx.setAttribute("text-anchor", "end");
        tx.textContent = `${tv}${ySuffix}`;
        svg.appendChild(tx);
      });

      const xAxis = svgEl("line");
      xAxis.setAttribute("x1", padL);
      xAxis.setAttribute("x2", padL + innerW);
      xAxis.setAttribute("y1", padT + innerH);
      xAxis.setAttribute("y2", padT + innerH);
      xAxis.setAttribute("stroke", "rgba(255,255,255,0.18)");
      xAxis.setAttribute("stroke-width", "2");
      svg.appendChild(xAxis);

      const labelCount = 6;
      const idxs = [];
      for(let i=0;i<labelCount;i++){
        const idx = Math.round(i * (xLabels.length - 1) / (labelCount - 1));
        if(!idxs.includes(idx)) idxs.push(idx);
      }

      idxs.forEach(idx => {
        const x = padL + (innerW * idx) / (data.length - 1);

        const tick = svgEl("line");
        tick.setAttribute("x1", x);
        tick.setAttribute("x2", x);
        tick.setAttribute("y1", padT + innerH);
        tick.setAttribute("y2", padT + innerH + 8);
        tick.setAttribute("stroke", "rgba(255,255,255,0.18)");
        tick.setAttribute("stroke-width", "2");
        svg.appendChild(tick);

        const tx = svgEl("text");
        tx.setAttribute("x", x);
        tx.setAttribute("y", padT + innerH + 30);
        tx.setAttribute("fill", "#fff");
        tx.setAttribute("opacity", "0.68");
        tx.setAttribute("font-size", "18");
        tx.setAttribute("text-anchor", "middle");
        tx.textContent = xLabels[idx] ?? "";
        svg.appendChild(tx);
      });

      const xStep = innerW / (data.length - 1);
      let d = "";
      data.forEach((v,i)=>{
        const x = padL + xStep*i;
        const val = Number.isFinite(v) ? v : (i>0 ? data[i-1] : clean[0]);
        const y = padT + (1 - (val-min)/(max-min)) * innerH;
        d += (i===0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
      });

      const path = svgEl("path");
      path.setAttribute("d", d);
      path.setAttribute("fill","none");
      path.setAttribute("stroke", stroke || "#fff");
      path.setAttribute("stroke-width","4");
      path.setAttribute("stroke-linecap","round");
      path.setAttribute("stroke-linejoin","round");
      svg.appendChild(path);
    }

    function computeTodayHiLo(periods){
      const todayStr = new Date().toDateString();
      const todaysTemps = periods
        .filter(p => new Date(p.startTime).toDateString() === todayStr)
        .map(p => p.temperature)
        .filter(v => Number.isFinite(v));

      const base = todaysTemps.length
        ? todaysTemps
        : periods.map(p => p.temperature).filter(v => Number.isFinite(v));

      if (!base.length) return { hi:null, lo:null };
      return { hi: Math.max(...base), lo: Math.min(...base) };
    }

    async function loadWeatherAndGraphs(){
      try{
        const pointsUrl = `https://api.weather.gov/points/${LAT},${LON}`;
        const pointsRes = await fetch(pointsUrl, { headers: { "Accept":"application/geo+json" } });
        if(!pointsRes.ok) throw new Error(`points ${pointsRes.status}`);
        const points = await pointsRes.json();

        const hourlyUrl = points?.properties?.forecastHourly;
        if(!hourlyUrl) throw new Error("No forecastHourly URL returned");

        const hourlyRes = await fetch(hourlyUrl, { headers: { "Accept":"application/geo+json" } });
        if(!hourlyRes.ok) throw new Error(`hourly ${hourlyRes.status}`);
        const hourly = await hourlyRes.json();

        const periods = (hourly?.properties?.periods || []).slice(0, HOURS_TO_PLOT);
        const updated = hourly?.properties?.updated;
        if(periods.length === 0) throw new Error("No periods");

        const p0 = periods[0];

        document.getElementById("wxTemp").textContent = `${p0.temperature}°`;
        document.getElementById("wxDesc").textContent = p0.shortForecast || "";
        document.getElementById("wxUpdated").textContent =
          updated ? `Updated ${new Date(updated).toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" })}` : "";

        const { hi, lo } = computeTodayHiLo(periods);
        document.getElementById("wxHigh").textContent = (hi == null) ? "--°" : `${hi}°`;
        document.getElementById("wxLow").textContent  = (lo == null) ? "--°" : `${lo}°`;

        document.getElementById("wxIcon").innerHTML = iconSvg(pickIcon(p0.shortForecast));

        const xLabels = periods.map(p => hourLabel(p.startTime));
        const temps = periods.map(p => Number.isFinite(p.temperature) ? p.temperature : null);
        const winds = periods.map(p => parseWindMph(p.windSpeed));
        const rains = periods.map(p => {
          const v = p?.probabilityOfPrecipitation?.value;
          return Number.isFinite(v) ? v : 0;
        });

        const start = new Date(periods[0].startTime).toLocaleTimeString([], { hour:"numeric", hour12:true });
        const end = new Date(periods[periods.length-1].startTime).toLocaleTimeString([], { hour:"numeric", hour12:true });

        document.getElementById("tempMeta").textContent = `${start}–${end}`;
        document.getElementById("windMeta").textContent = `${start}–${end}`;

        drawLineGraphWithAxes(document.getElementById("tempSvg"), temps, xLabels, "°", "#fff");
        drawLineGraphWithAxes(document.getElementById("windSvg"), winds, xLabels, "", "rgba(255,255,255,0.80)");

        const rainWrap = document.getElementById("rainWrap");
        const anyRain = rains.some(v => Number.isFinite(v) && v > 0);
        if(anyRain){
          rainWrap.style.display = "block";
          document.getElementById("rainMeta").textContent = `${start}–${end}`;
          drawLineGraphWithAxes(document.getElementById("rainSvg"), rains, xLabels, "%", "rgba(255,255,255,0.85)");
        }else{
          rainWrap.style.display = "none";
        }
      }catch(err){
        document.getElementById("wxDesc").textContent = "Weather unavailable";
        document.getElementById("wxUpdated").textContent = "";
        console.error(err);
      }
    }

    // Init
    updateClock();
    setInterval(updateClock, 1000);

    loadWeatherAndGraphs();
    setInterval(loadWeatherAndGraphs, 2 * 60 * 1000);

    bustSatelliteCache();
    setInterval(bustSatelliteCache, 5 * 60 * 1000);

    setTimeout(() => location.reload(), REFRESH_MINUTES * 60 * 1000);
  </script>
</body>
</html>

