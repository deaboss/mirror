<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Mirror</title>
  <style>
    :root{
      --bg:#000000;
      --fg:#ffffff;
      --grid:rgba(255,255,255,0.12);
      --card:rgba(255,255,255,0.04);
      --border:rgba(255,255,255,0.12);
    }
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Helvetica Neue",Arial,sans-serif;
      overflow:hidden;
    }
    .wrap{
      height:100%;
      display:grid;
      grid-template-rows:auto auto 1fr;
      gap:14px;
      padding:28px;
      box-sizing:border-box;
    }
    .top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:24px;
    }
    .time{display:flex;flex-direction:column;gap:6px;line-height:1.05;letter-spacing:-0.02em}
    .clock{font-size:clamp(44px,6vw,92px);font-weight:600}
    .date{font-size:clamp(18px,2vw,26px);font-weight:500}

    .weather{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:6px;
      max-width:45vw;
    }
    .weather .loc{
      font-size:14px;
      letter-spacing:0.06em;
      text-transform:uppercase;
    }
    .weather .main{
      font-size:clamp(18px,2.2vw,28px);
      font-weight:600;
      letter-spacing:-0.01em;
    }
    .weather .sub{font-size:14px}

    .graphs{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .graphCard{
      border-radius:16px;
      border:1px solid var(--border);
      background:var(--card);
      padding:12px 14px;
    }
    .graphHeader{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
      margin-bottom:8px;
    }
    .graphTitle{
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--fg);
    }
    .graphMeta{
      font-size:12px;
      color:var(--fg);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60%;
      text-align:right;
    }
    svg{width:100%;height:72px;display:block}

    .sat{
      width:100%;
      height:100%;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--border);
    }
    .sat img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter:contrast(1.05) saturate(1.05);
      opacity:0.95;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="time">
        <div id="clock" class="clock">--:--</div>
        <div id="date" class="date">---</div>
      </div>

      <div class="weather">
        <div class="loc">San Luis Obispo, CA</div>
        <div id="wxMain" class="main">Loading weather…</div>
        <div id="wxSub" class="sub"></div>
      </div>
    </div>

    <div class="graphs">
      <div class="graphCard">
        <div class="graphHeader">
          <div class="graphTitle">Temperature (hourly)</div>
          <div id="tempMeta" class="graphMeta"></div>
        </div>
        <svg id="tempSvg" viewBox="0 0 1000 120" preserveAspectRatio="none" aria-label="Temperature graph"></svg>
      </div>

      <div class="graphCard">
        <div class="graphHeader">
          <div class="graphTitle">Surface wind (hourly)</div>
          <div id="windMeta" class="graphMeta"></div>
        </div>
        <svg id="windSvg" viewBox="0 0 1000 120" preserveAspectRatio="none" aria-label="Wind graph"></svg>
      </div>

      <div class="graphCard" id="rainCard" style="display:none">
        <div class="graphHeader">
          <div class="graphTitle">Rain chance (hourly)</div>
          <div id="rainMeta" class="graphMeta"></div>
        </div>
        <svg id="rainSvg" viewBox="0 0 1000 120" preserveAspectRatio="none" aria-label="Rain chance graph"></svg>
      </div>
    </div>

    <div class="sat">
      <img id="satImg"
           alt="GOES-18 Satellite"
           src="https://cdn.star.nesdis.noaa.gov/GOES18/ABI/SECTOR/psw/GEOCOLOR/20260280201_GOES18-ABI-psw-GEOCOLOR-2400x2400.jpg" />
    </div>
  </div>

  <script>
    // Full page refresh interval (minutes)
    const REFRESH_MINUTES = 5;

    // Coords from your NWS link
    const LAT = 35.2858;
    const LON = -120.6627;

    // How many hours to plot
    const HOURS_TO_PLOT = 24;

    // Satellite image (cache-busted in JS)
    const satBaseUrl = "https://cdn.star.nesdis.noaa.gov/GOES18/ABI/SECTOR/psw/GEOCOLOR/20260280201_GOES18-ABI-psw-GEOCOLOR-2400x2400.jpg";

    function pad2(n){ return String(n).padStart(2,"0"); }

    function updateClock(){
      const now = new Date();
      document.getElementById("clock").textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
      document.getElementById("date").textContent = now.toLocaleDateString(undefined, {
        weekday:"long", year:"numeric", month:"long", day:"numeric"
      });
    }

    function bustSatelliteCache(){
      document.getElementById("satImg").src = `${satBaseUrl}?t=${Date.now()}`;
    }

    function parseWindMph(windSpeedStr){
      // Examples: "5 mph", "5 to 10 mph", "10 mph"
      if(!windSpeedStr) return null;
      const nums = windSpeedStr.match(/\d+/g);
      if(!nums || nums.length === 0) return null;
      const a = Number(nums[0]);
      if(nums.length >= 2){
        const b = Number(nums[1]);
        if(Number.isFinite(a) && Number.isFinite(b)) return (a + b) / 2;
      }
      return Number.isFinite(a) ? a : null;
    }

    function formatHourLabel(iso){
      const d = new Date(iso);
      return d.toLocaleTimeString([], { hour:"numeric" });
    }

    function drawLineGraph(svgEl, data, stroke){
      const W=1000,H=120,padX=18,padY=14;
      const innerW=W-padX*2, innerH=H-padY*2;

      svgEl.innerHTML = "";

      const clean = data.filter(v => Number.isFinite(v));
      if(clean.length < 2){
        const t = document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x", W/2);
        t.setAttribute("y", H/2);
        t.setAttribute("fill", "#ffffff");
        t.setAttribute("font-size", "18");
        t.setAttribute("text-anchor", "middle");
        t.textContent = "No data";
        svgEl.appendChild(t);
        return;
      }

      let min=Math.min(...clean), max=Math.max(...clean);
      if(min===max){ min-=1; max+=1; }
      const xStep = innerW / (data.length - 1);

      // grid
      for(const frac of [0.33,0.66]){
        const y = padY + innerH*frac;
        const line = document.createElementNS("http://www.w3.org/2000/svg","line");
        line.setAttribute("x1", padX);
        line.setAttribute("x2", padX + innerW);
        line.setAttribute("y1", y);
        line.setAttribute("y2", y);
        line.setAttribute("stroke", "rgba(255,255,255,0.12)");
        line.setAttribute("stroke-width", "2");
        svgEl.appendChild(line);
      }

      let d="";
      data.forEach((v,i)=>{
        const x = padX + xStep*i;
        const val = Number.isFinite(v) ? v : (i>0 ? data[i-1] : clean[0]);
        const y = padY + (1 - (val-min)/(max-min))*innerH;
        d += (i===0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
      });

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d", d);
      path.setAttribute("fill","none");
      path.setAttribute("stroke", stroke);
      path.setAttribute("stroke-width","4");
      path.setAttribute("stroke-linecap","round");
      path.setAttribute("stroke-linejoin","round");
      svgEl.appendChild(path);
    }

    async function loadWeatherAndGraphs(){
      const wxMain = document.getElementById("wxMain");
      const wxSub  = document.getElementById("wxSub");

      try{
        const pointsUrl = `https://api.weather.gov/points/${LAT},${LON}`;
        const pointsRes = await fetch(pointsUrl, { headers: { "Accept":"application/geo+json" } });
        if(!pointsRes.ok) throw new Error(`points ${pointsRes.status}`);
        const points = await pointsRes.json();

        const hourlyUrl = points?.properties?.forecastHourly;
        if(!hourlyUrl) throw new Error("No forecastHourly URL returned");

        const hourlyRes = await fetch(hourlyUrl, { headers: { "Accept":"application/geo+json" } });
        if(!hourlyRes.ok) throw new Error(`hourly ${hourlyRes.status}`);
        const hourly = await hourlyRes.json();

        const periods = (hourly?.properties?.periods || []).slice(0, HOURS_TO_PLOT);
        const updated = hourly?.properties?.updated;

        if(periods.length === 0) throw new Error("No periods");

        // summary (first hour)
        const p0 = periods[0];
        const temp0 = `${p0.temperature}°${p0.temperatureUnit}`;
        const short0 = p0.shortForecast || "";
        const wind0 = (p0.windDirection && p0.windSpeed) ? `Wind ${p0.windDirection} ${p0.windSpeed}` : "";

        wxMain.textContent = `${temp0}  ${short0}`.trim();
        wxSub.textContent  = [wind0, updated ? `Updated ${new Date(updated).toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" })}` : ""]
          .filter(Boolean).join(" • ");

        // graph arrays
        const temps = periods.map(p => Number.isFinite(p.temperature) ? p.temperature : null);
        const winds = periods.map(p => parseWindMph(p.windSpeed));
        const rains = periods.map(p => {
          const v = p?.probabilityOfPrecipitation?.value;
          return Number.isFinite(v) ? v : 0;
        });

        const startLabel = formatHourLabel(periods[0].startTime);
        const endLabel = formatHourLabel(periods[periods.length-1].startTime);

        document.getElementById("tempMeta").textContent = `${startLabel}–${endLabel}`;
        document.getElementById("windMeta").textContent = `${startLabel}–${endLabel}`;

        drawLineGraph(document.getElementById("tempSvg"), temps, "#ffffff");
        drawLineGraph(document.getElementById("windSvg"), winds, "rgba(255,255,255,0.85)");

        const anyRain = rains.some(v => Number.isFinite(v) && v > 0);
        const rainCard = document.getElementById("rainCard");
        if(anyRain){
          rainCard.style.display = "block";
          document.getElementById("rainMeta").textContent = `${startLabel}–${endLabel}`;
          drawLineGraph(document.getElementById("rainSvg"), rains, "rgba(255,255,255,0.9)");
        }else{
          rainCard.style.display = "none";
        }

      }catch(err){
        wxMain.textContent = "Weather unavailable";
        wxSub.textContent = "";
        console.error(err);
      }
    }

    // Init
    updateClock();
    setInterval(updateClock, 1000);

    loadWeatherAndGraphs();
    bustSatelliteCache();

    // refresh weather/graphs without full reload
    setInterval(loadWeatherAndGraphs, 2 * 60 * 1000);

    // refresh satellite image periodically (optional)
    setInterval(bustSatelliteCache, 5 * 60 * 1000);

    // full page refresh
    setTimeout(() => location.reload(), REFRESH_MINUTES * 60 * 1000);
  </script>
</body>
</html>
